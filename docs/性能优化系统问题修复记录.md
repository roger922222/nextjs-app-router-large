# Next.js 性能优化系统问题修复记录

## 问题概述

在部署 Next.js 性能优化系统时，遇到了多个关键技术问题，主要包括模块解析错误、异步处理不当、以及服务器端模块在客户端使用等问题。

## 主要问题及解决方案

### 1. 性能测试系统模块错误

**问题描述：**
```
GET /performance-test 500 in 271ms
Module not found: Can't resolve 'perf_hooks'
```

**错误原因：**
- `perf_hooks` 是 Node.js 的服务器端专用模块
- 在 Next.js 的客户端组件中使用了服务器端模块
- 浏览器环境不支持 `perf_hooks` 模块

**解决方案：**
- 创建浏览器兼容的性能测试版本
- 使用 Web API 的 `performance.now()` 替代 `perf_hooks`
- 移除服务器端内存监控功能
- 保持核心测试逻辑不变

**修复文件：**
- 新建 `/lib/performance-tests-browser.ts`
- 更新 `/components/PerformanceTestDemo.tsx` 的引用

**技术细节：**
```typescript
// 修复前 (服务器端)
import { performance } from 'perf_hooks';
const startTime = performance.now();

// 修复后 (浏览器兼容)
const testStart = performance.now();
const memoryBefore = performance.memory ? (performance as any).memory.usedJSHeapSize : 0;
```

### 2. 异步函数调用错误

**问题描述：**
```
TypeError: Failed to parse URL from [object Promise]/api/posts
Invalid URL
```

**错误原因：**
- `getBaseUrl()` 函数返回的是 Promise
- 在字符串模板中直接使用了未解析的 Promise 对象
- 需要等待 Promise 解析完成后再使用

**解决方案：**
- 在所有使用 `getBaseUrl()` 的地方添加 `await`
- 确保异步函数正确解析后再进行字符串拼接

**修复文件：**
- `/app/server/page.tsx`
- `/app/server/parallel/page.tsx`
- `/app/server/serial/page.tsx`
- `/app/server/dedup/page.tsx`
- `/app/server/full-route-cache/page.tsx`

**技术细节：**
```typescript
// 修复前
const baseUrl = getBaseUrl();
const dataCacheRes = await fetch(`${baseUrl}/api/posts`, ...);

// 修复后
const baseUrl = await getBaseUrl();
const dataCacheRes = await fetch(`${baseUrl}/api/posts`, ...);
```

### 3. 图片域名配置问题

**问题描述：**
```
Invalid src prop (https://picsum.photos/400/300?random=11) on `next/image`
hostname "picsum.photos" is not configured under images in your `next.config.js`
```

**错误原因：**
- Next.js Image 组件默认只允许本地图片
- 外部图片域名需要在配置中显式声明
- 安全考虑防止任意域名图片加载

**解决方案：**
- 在 `next.config.ts` 中添加远程图片域名配置
- 支持 `picsum.photos` 和 `images.unsplash.com`

**修复文件：**
- `/next.config.ts`

**技术细节：**
```typescript
// 修复配置
images: {
  remotePatterns: [
    {
      protocol: 'https',
      hostname: 'picsum.photos',
      pathname: '/**',
    },
    {
      protocol: 'https',
      hostname: 'images.unsplash.com',
      pathname: '/**',
    },
  ],
}
```

### 4. styled-jsx 服务器组件错误

**问题描述：**
```
'client-only' cannot be imported from a Server Component module
The error was caused by using 'styled-jsx'
```

**错误原因：**
- 在服务器组件中使用了 styled-jsx
- styled-jsx 只能在客户端组件中使用
- 服务器组件默认不支持 CSS-in-JS 方案

**解决方案：**
- 移除 styled-jsx，改用标准 CSS 类名
- 使用 Tailwind CSS 或普通 CSS 文件
- 保持样式功能不变，提升兼容性

**修复文件：**
- `/app/image-optimization/page.tsx`
- `/app/critical-render-optimization/page.tsx`

**技术细节：**
```typescript
// 修复前
<style jsx>{`
  .container { max-width: 1200px; }
`}</style>

// 修复后
<div className="container mx-auto px-4 py-8">
  <style>{`
    .container { max-width: 1200px; }
  `}</style>
</div>
```

### 5. 缺失的演示页面路径

**问题描述：**
```
GET /critical-rendering 404 in 45ms
```

**错误原因：**
- 仪表板中的链接路径与实际文件路径不匹配
- 某些演示页面目录未创建
- 路由配置不完整

**解决方案：**
- 创建缺失的演示页面目录
- 确保链接路径与文件路径一致
- 提供简化的演示功能

**修复文件：**
- 新建 `/app/critical-rendering/page.tsx`
- 新建 `/app/code-splitting/page.tsx`
- 新建 `/app/smart-caching/page.tsx`

## 修复经验总结

### 1. 环境适配原则
- 客户端代码避免使用 Node.js 专用模块
- 服务器组件避免使用浏览器专用 API
- 合理使用 `"use client"` 指令标记客户端组件

### 2. 异步处理最佳实践
- 始终正确处理 Promise 和 async/await
- 在字符串拼接前确保异步值已解析
- 使用 try-catch 处理异步错误

### 3. 配置管理
- 及时更新 Next.js 配置以支持新功能
- 外部资源需要在配置中显式声明
- 保持配置的安全性和限制性

### 4. 错误预防策略
- 开发阶段进行全面的路径测试
- 使用 TypeScript 类型检查预防错误
- 建立完整的错误处理和日志系统

## 系统状态

经过全面修复，Next.js 性能优化系统现已完全可用：

✅ **所有演示页面正常访问**
✅ **性能测试系统运行稳定**
✅ **图片优化功能完整**
✅ **缓存策略演示有效**
✅ **加载体验优化正常**
✅ **代码分割功能可用**
✅ **数据压缩演示完整**
✅ **性能监控实时有效**

系统现在提供了完整的性能优化学习和测试环境，用户可以通过交互式演示深入了解各种优化技术的实际效果。