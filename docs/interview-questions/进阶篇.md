# Next.js è¿›é˜¶ç¯‡ - é«˜çº§æ¦‚å¿µä¸æ¶æ„è®¾è®¡

## 1. App Router vs Pages Router æ·±åº¦å¯¹æ¯”

### 1.1 æ¶æ„å·®å¼‚

**Pages Router (ä¼ ç»Ÿ)**
- åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”±
- ä½¿ç”¨ `getStaticProps`, `getServerSideProps`, `getInitialProps`
- å®¢æˆ·ç«¯æ¸²æŸ“ä¸ºä¸»
- è‡ªåŠ¨ä»£ç åˆ†å‰²

**App Router (æ–°ä¸€ä»£)**
- åŸºäº React Server Components
- æ”¯æŒåµŒå¥—å¸ƒå±€å’Œå¹¶è¡Œè·¯ç”±
- æœåŠ¡å™¨ç«¯æ¸²æŸ“ä¸ºä¸»
- æ›´ç»†ç²’åº¦çš„æ•°æ®è·å–æ§åˆ¶

### 1.2 æ€§èƒ½å¯¹æ¯”

```typescript
// Pages Router - å…¨é¡µé¢é‡æ–°æ¸²æŸ“
export const getServerSideProps = async () => {
  const data = await fetchData()
  return { props: { data } }
}

// App Router - ç»„ä»¶çº§æ•°æ®è·å–
async function UserProfile({ id }) {
  const user = await getUser(id) // ä»…æ­¤ç»„ä»¶éœ€è¦æ•°æ®
  return <div>{user.name}</div>
}
```

### 1.3 è¿ç§»ç­–ç•¥

1. **æ¸è¿›å¼è¿ç§»**ï¼šä»éå…³é”®é¡µé¢å¼€å§‹
2. **æ··åˆæ¨¡å¼**ï¼šåŒæ—¶æ”¯æŒä¸¤ç§è·¯ç”±ç³»ç»Ÿ
3. **æ•°æ®è·å–é‡æ„**ï¼šå°† `getStaticProps` è½¬ä¸º Server Components

## 2. Server Components vs Client Components

### 2.1 æ ¸å¿ƒåŒºåˆ«

**Server Components**
- åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“
- å¯ç›´æ¥è®¿é—®æ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿ
- é›¶ JavaScript bundle å¤§å°
- æ”¯æŒå¼‚æ­¥ç»„ä»¶

**Client Components**
- åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ
- æ”¯æŒäº¤äº’æ€§å’Œæµè§ˆå™¨ API
- éœ€è¦ "use client" æŒ‡ä»¤
- å¯ä»¥è®¿é—®å®¢æˆ·ç«¯çŠ¶æ€

### 2.2 ä½¿ç”¨åœºæ™¯

```typescript
// Server Component - æ•°æ®è·å–
async function ProductList() {
  const products = await db.products.findMany()
  return (
    <div>
      {products.map(product => (
        <ProductCard key={product.id} product={product} />
      ))}
    </div>
  )
}

// Client Component - äº¤äº’åŠŸèƒ½
"use client"

function ProductCard({ product }) {
  const [isLiked, setIsLiked] = useState(false)
  
  return (
    <div>
      <h3>{product.name}</h3>
      <button onClick={() => setIsLiked(!isLiked)}>
        {isLiked ? "â¤ï¸" : "ğŸ¤"}
      </button>
    </div>
  )
}
```

## 3. ä¸‰å±‚ç¼“å­˜æœºåˆ¶è¯¦è§£

### 3.1 Request Memoization (è¯·æ±‚çº§ç¼“å­˜)

```typescript
// åŒä¸€ä¸ªè¯·æ±‚å†…ï¼Œç›¸åŒçš„ fetch åªä¼šæ‰§è¡Œä¸€æ¬¡
async function ComponentA() {
  const data = await fetch('https://api.example.com/data')
  return <div>{data}</div>
}

async function ComponentB() {
  const data = await fetch('https://api.example.com/data') // å¤ç”¨ç¼“å­˜
  return <div>{data}</div>
}
```

### 3.2 Data Cache (æ•°æ®ç¼“å­˜)

```typescript
// æŒä¹…åŒ–ç¼“å­˜ï¼Œå¯é…ç½® revalidate
async function getData() {
  const res = await fetch('https://api.example.com/data', {
    next: { 
      revalidate: 3600, // 1å°æ—¶ç¼“å­˜
      tags: ['data-tag'] // æ ‡ç­¾åŒ–ç¼“å­˜
    }
  })
  return res.json()
}

// æŒ‰éœ€é‡æ–°éªŒè¯
export async function revalidateData() {
  revalidateTag('data-tag')
}
```

### 3.3 Full Route Cache (å…¨è·¯ç”±ç¼“å­˜)

```typescript
// é™æ€é¡µé¢è‡ªåŠ¨ç¼“å­˜
export const dynamic = 'force-static' // å¼ºåˆ¶é™æ€ç”Ÿæˆ
export const revalidate = 86400       // 24å°æ—¶é‡æ–°éªŒè¯

export default async function Page() {
  return <div>Static Content</div>
}
```

## 4. æµå¼æ¸²æŸ“ä¸ Suspense

### 4.1 åŸºç¡€æ¦‚å¿µ

æµå¼æ¸²æŸ“å…è®¸æœåŠ¡å™¨é€æ­¥å‘é€ HTMLï¼Œæé«˜æ„ŸçŸ¥æ€§èƒ½ï¼š

```typescript
import { Suspense } from 'react'

async function SlowComponent() {
  await new Promise(resolve => setTimeout(resolve, 3000))
  return <div>Loaded!</div>
}

export default function Page() {
  return (
    <div>
      <h1>Welcome</h1>
      <Suspense fallback={<div>Loading...</div>}>
        <SlowComponent />
      </Suspense>
    </div>
  )
}
```

## 5. å¹¶è¡Œè·¯ç”±ä¸æ‹¦æˆª

### 5.1 å¹¶è¡Œè·¯ç”±

```typescript
// app/dashboard/@analytics/page.tsx
export default function Analytics() {
  return <div>Analytics Content</div>
}

// app/dashboard/@notifications/page.tsx  
export default function Notifications() {
  return <div>Notifications Content</div>
}

// app/dashboard/layout.tsx
export default function Layout({
  children,
  analytics,
  notifications
}: {
  children: React.ReactNode
  analytics: React.ReactNode
  notifications: React.ReactNode
}) {
  return (
    <div>
      <div>{children}</div>
      <div className="sidebar">
        {analytics}
        {notifications}
      </div>
    </div>
  )
}
```

## 6. é«˜çº§æ•°æ®ç®¡ç†

### 6.1 æœåŠ¡å™¨æ“ä½œ

```typescript
// app/actions.ts
'use server'

export async function createPost(formData: FormData) {
  const title = formData.get('title')
  const content = formData.get('content')
  
  // æ•°æ®éªŒè¯
  if (!title || !content) {
    return { error: 'Missing required fields' }
  }
  
  // æ•°æ®åº“æ“ä½œ
  const post = await db.posts.create({
    data: { title, content }
  })
  
  // é‡æ–°éªŒè¯ç¼“å­˜
  revalidatePath('/posts')
  
  return { success: true, post }
}
```

### 6.2 ä¹è§‚æ›´æ–°

```typescript
"use client"

import { useOptimistic, useTransition } from 'react'
import { createPost } from './actions'

export function PostForm() {
  const [isPending, startTransition] = useTransition()
  const [optimisticPosts, addOptimisticPost] = useOptimistic(
    posts,
    (state, newPost) => [...state, { ...newPost, pending: true }]
  )
  
  async function handleSubmit(formData: FormData) {
    const newPost = {
      title: formData.get('title'),
      content: formData.get('content')
    }
    
    startTransition(() => {
      addOptimisticPost(newPost)
      createPost(formData)
    })
  }
  
  return (
    <form action={handleSubmit}>
      <input name="title" placeholder="Title" />
      <textarea name="content" placeholder="Content" />
      <button type="submit" disabled={isPending}>
        {isPending ? 'Creating...' : 'Create Post'}
      </button>
    </form>
  )
}
```

## 7. å®‰å…¨æ€§æœ€ä½³å®è·µ

### 7.1 XSS é˜²æŠ¤

```typescript
// å®‰å…¨çš„ HTML æ¸²æŸ“
function SafeHTML({ content }: { content: string }) {
  // ä½¿ç”¨ DOMPurify æ¸…ç† HTML
  const sanitizedContent = DOMPurify.sanitize(content)
  return <div dangerouslySetInnerHTML={{ __html: sanitizedContent }} />
}

// é¿å…ç›´æ¥æ¸²æŸ“ç”¨æˆ·è¾“å…¥
function UserProfile({ bio }: { bio: string }) {
  // âœ… æ­£ç¡®ï¼šè½¬ä¹‰æ–‡æœ¬
  return <div>{bio}</div>
  
  // âŒ é”™è¯¯ï¼šå¯èƒ½å¯¼è‡´ XSS
  // return <div dangerouslySetInnerHTML={{ __html: bio }} />
}
```

### 7.2 CSRF é˜²æŠ¤

```typescript
// æœåŠ¡å™¨æ“ä½œå¤©ç„¶é˜²æŠ¤ CSRF
'use server'

export async function updateProfile(formData: FormData) {
  // Next.js è‡ªåŠ¨éªŒè¯æ¥æº
  const session = await getSession()
  if (!session) {
    throw new Error('Unauthorized')
  }
  
  const userId = session.userId
  const updates = {
    name: formData.get('name'),
    email: formData.get('email')
  }
  
  await db.users.update({
    where: { id: userId },
    data: updates
  })
  
  revalidatePath('/profile')
}
```

### 7.3 SQL æ³¨å…¥é˜²æŠ¤

```typescript
// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
async function getUser(email: string) {
  // âœ… æ­£ç¡®ï¼šå‚æ•°åŒ–æŸ¥è¯¢
  return await db.users.findUnique({
    where: { email }
  })
  
  // âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
  // const query = `SELECT * FROM users WHERE email = '${email}'`
}

// è¾“å…¥éªŒè¯
import { z } from 'zod'

const userSchema = z.object({
  email: z.string().email(),
  age: z.number().min(18).max(120)
})

export async function createUser(data: unknown) {
  const validated = userSchema.parse(data)
  return await db.users.create({ data: validated })
}
```

## 8. å¾®æœåŠ¡æ¶æ„è®¾è®¡

### 8.1 æœåŠ¡æ‹†åˆ†ç­–ç•¥

```typescript
// æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†
// services/user-service.ts
export class UserService {
  async getUser(id: string) {
    return await db.users.findUnique({ where: { id } })
  }
  
  async updateUser(id: string, data: UpdateUserData) {
    return await db.users.update({ where: { id }, data })
  }
}

// services/product-service.ts
export class ProductService {
  async getProducts(filters: ProductFilters) {
    return await db.products.findMany({ where: filters })
  }
  
  async searchProducts(query: string) {
    return await db.products.findMany({
      where: {
        OR: [
          { name: { contains: query } },
          { description: { contains: query } }
        ]
      }
    })
  }
}
```

### 8.2 API ç½‘å…³æ¨¡å¼

```typescript
// app/api/gateway/[service]/[...path]/route.ts
import { NextRequest, NextResponse } from 'next/server'

const SERVICE_URLS = {
  user: process.env.USER_SERVICE_URL,
  product: process.env.PRODUCT_SERVICE_URL,
  order: process.env.ORDER_SERVICE_URL
}

export async function handler(
  request: NextRequest,
  { params }: { params: { service: string; path: string[] } }
) {
  const { service, path } = params
  const serviceUrl = SERVICE_URLS[service]
  
  if (!serviceUrl) {
    return NextResponse.json({ error: 'Service not found' }, { status: 404 })
  }
  
  const url = new URL(path.join('/'), serviceUrl)
  url.search = request.nextUrl.search
  
  const response = await fetch(url, {
    method: request.method,
    headers: request.headers,
    body: request.body
  })
  
  return new NextResponse(response.body, {
    status: response.status,
    headers: response.headers
  })
}

export { handler as GET, handler as POST, handler as PUT, handler as DELETE }
```

## 9. é¢è¯•å¸¸è§é—®é¢˜

### 9.1 App Router ç›¸å…³

**Q: App Router ç›¸æ¯” Pages Router çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ**

A: ä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬ï¼š
1. **æ›´å¥½çš„æ€§èƒ½**ï¼šServer Components å‡å°‘ JavaScript bundle å¤§å°
2. **æ›´çµæ´»çš„æ•°æ®è·å–**ï¼šç»„ä»¶çº§æ•°æ®è·å–ï¼Œé¿å…å…¨é¡µé¢é‡æ–°æ¸²æŸ“
3. **æ›´å¼ºçš„ç¼“å­˜æœºåˆ¶**ï¼šä¸‰å±‚ç¼“å­˜æ¶æ„ï¼ˆRequest Memoizationã€Data Cacheã€Full Route Cacheï¼‰
4. **æ›´å¥½çš„å¼€å‘ä½“éªŒ**ï¼šåµŒå¥—å¸ƒå±€ã€å¹¶è¡Œè·¯ç”±ã€é”™è¯¯è¾¹ç•Œç­‰

**Q: å¦‚ä½•åœ¨ App Router ä¸­å®ç°èº«ä»½éªŒè¯ï¼Ÿ**

A: å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š
1. **ä¸­é—´ä»¶**ï¼šåœ¨ `middleware.ts` ä¸­æ£€æŸ¥è®¤è¯çŠ¶æ€
2. **Server Components**ï¼šç›´æ¥è®¿é—® session å’Œæ•°æ®åº“
3. **API è·¯ç”±**ï¼šå¤„ç†ç™»å½•ã€ç™»å‡ºé€»è¾‘

### 9.2 Server Components ç›¸å…³

**Q: Server Components å’Œ Client Components å¦‚ä½•é€‰æ‹©ï¼Ÿ**

A: é€‰æ‹©åŸåˆ™ï¼š
- **Server Components**ï¼šæ•°æ®è·å–ã€é™æ€å†…å®¹ã€å‡å°‘ bundle å¤§å°
- **Client Components**ï¼šç”¨æˆ·äº¤äº’ã€æµè§ˆå™¨ APIã€å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†

**Q: Server Components æœ‰å“ªäº›é™åˆ¶ï¼Ÿ**

A: ä¸»è¦é™åˆ¶ï¼š
- ä¸èƒ½ä½¿ç”¨æµè§ˆå™¨ API
- ä¸èƒ½ä½¿ç”¨ React çš„å®¢æˆ·ç«¯ç‰¹æ€§ï¼ˆuseStateã€useEffect ç­‰ï¼‰
- ä¸èƒ½ç›´æ¥å“åº”ç”¨æˆ·äº¤äº’

### 9.3 ç¼“å­˜ç­–ç•¥ç›¸å…³

**Q: å¦‚ä½•æ¸…é™¤ Next.js ç¼“å­˜ï¼Ÿ**

A: å¤šç§æ–¹å¼ï¼š
1. **é‡æ–°éªŒè¯æ ‡ç­¾**ï¼š`revalidateTag('tag-name')`
2. **é‡æ–°éªŒè¯è·¯å¾„**ï¼š`revalidatePath('/path')`
3. **æ—¶é—´è¿‡æœŸ**ï¼šåœ¨ fetch ä¸­è®¾ç½® `revalidate` é€‰é¡¹
4. **æ‰‹åŠ¨æ¸…é™¤**ï¼šåˆ é™¤ `.next/cache` ç›®å½•

**Q: ä¸‰å±‚ç¼“å­˜æœºåˆ¶çš„å·¥ä½œæµç¨‹ï¼Ÿ**

A: å·¥ä½œæµç¨‹ï¼š
1. **Request Memoization**ï¼šåŒä¸€è¯·æ±‚å†…ç¼“å­˜é‡å¤çš„æ•°æ®è·å–
2. **Data Cache**ï¼šè·¨è¯·æ±‚ç¼“å­˜ API å“åº”
3. **Full Route Cache**ï¼šç¼“å­˜æ•´ä¸ªé¡µé¢çš„æ¸²æŸ“ç»“æœ

### 9.4 æ€§èƒ½ä¼˜åŒ–ç›¸å…³

**Q: å¦‚ä½•ä¼˜åŒ– Next.js åº”ç”¨çš„é¦–å±åŠ è½½æ—¶é—´ï¼Ÿ**

A: ä¼˜åŒ–ç­–ç•¥ï¼š
1. **å›¾ç‰‡ä¼˜åŒ–**ï¼šä½¿ç”¨ Next.js Image ç»„ä»¶ï¼ŒWebP æ ¼å¼
2. **ä»£ç åˆ†å‰²**ï¼šåŠ¨æ€å¯¼å…¥éå…³é”®ç»„ä»¶
3. **å­—ä½“ä¼˜åŒ–**ï¼šä½¿ç”¨ `next/font` è‡ªåŠ¨ä¼˜åŒ–
4. **å…³é”® CSS**ï¼šå†…è”å…³é”®æ ·å¼
5. **é¢„åŠ è½½**ï¼šé¢„åŠ è½½å…³é”®èµ„æº

**Q: å¦‚ä½•ç›‘æ§ Next.js åº”ç”¨æ€§èƒ½ï¼Ÿ**

A: ç›‘æ§æ–¹æ³•ï¼š
1. **Web Vitals**ï¼šä½¿ç”¨ `next/web-vitals`
2. **è‡ªå®šä¹‰æŒ‡æ ‡**ï¼šä½¿ç”¨ Performance API
3. **é”™è¯¯ç›‘æ§**ï¼šä½¿ç”¨ Sentryã€LogRocket ç­‰å·¥å…·
4. **æœåŠ¡å™¨ç›‘æ§**ï¼šä½¿ç”¨ APM å·¥å…·ï¼ˆNew Relicã€Datadog ç­‰ï¼‰

### 9.5 å®‰å…¨æ€§ç›¸å…³

**Q: å¦‚ä½•é˜²æ­¢ XSS æ”»å‡»ï¼Ÿ**

A: é˜²æŠ¤æªæ–½ï¼š
1. **è‡ªåŠ¨è½¬ä¹‰**ï¼šReact é»˜è®¤è½¬ä¹‰ JSX å†…å®¹
2. **å±é™© HTML**ï¼šè°¨æ…ä½¿ç”¨ `dangerouslySetInnerHTML`
3. **è¾“å…¥éªŒè¯**ï¼šä½¿ç”¨ zodã€yup ç­‰åº“éªŒè¯è¾“å…¥
4. **CSP å¤´**ï¼šè®¾ç½®å†…å®¹å®‰å…¨ç­–ç•¥

**Q: Next.js å¦‚ä½•å¤„ç† CSRF æ”»å‡»ï¼Ÿ**

A: é˜²æŠ¤æœºåˆ¶ï¼š
1. **SameSite Cookie**ï¼šé»˜è®¤å¯ç”¨ SameSite å±æ€§
2. **æœåŠ¡å™¨æ“ä½œ**ï¼šServer Actions è‡ªåŠ¨éªŒè¯æ¥æº
3. **è‡ªå®šä¹‰ä»¤ç‰Œ**ï¼šå¯¹æ•æ„Ÿæ“ä½œä½¿ç”¨ CSRF ä»¤ç‰Œ

## 10. å®æˆ˜é¡¹ç›®å»ºè®®

### 10.1 ç”µå•†å¹³å°

**æŠ€æœ¯æ ˆ**ï¼š
- Next.js App Router
- PostgreSQL + Prisma
- Redis ç¼“å­˜
- Stripe æ”¯ä»˜
- AWS S3 å­˜å‚¨

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å•†å“å±•ç¤ºå’Œæœç´¢
- è´­ç‰©è½¦å’Œç»“è´¦
- ç”¨æˆ·è®¤è¯å’Œè®¢å•ç®¡ç†
- å®æ—¶åº“å­˜æ›´æ–°

### 10.2 å†…å®¹ç®¡ç†ç³»ç»Ÿ

**æŠ€æœ¯æ ˆ**ï¼š
- Next.js + Server Components
- Headless CMS (Contentful, Strapi)
- Elasticsearch æœç´¢
- CDN åŠ é€Ÿ

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å†…å®¹åˆ›å»ºå’Œç¼–è¾‘
- å¤šè¯­è¨€æ”¯æŒ
- SEO ä¼˜åŒ–
- æ€§èƒ½ç›‘æ§

### 10.3 å®æ—¶åä½œåº”ç”¨

**æŠ€æœ¯æ ˆ**ï¼š
- Next.js + WebSocket
- PostgreSQL + Redis
- Socket.io
- å®æ—¶åŒæ­¥ç®—æ³•

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å¤šäººå®æ—¶ç¼–è¾‘
- å†²çªè§£å†³
- ç¦»çº¿æ”¯æŒ
- ç‰ˆæœ¬æ§åˆ¶

## æ€»ç»“

Next.js çš„è¿›é˜¶æ¦‚å¿µæ¶µç›–äº†ç°ä»£ Web å¼€å‘çš„å„ä¸ªæ–¹é¢ï¼š

1. **æ¶æ„è®¾è®¡**ï¼šç†è§£ App Router å’Œ Server Components çš„ä¼˜åŠ¿
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæŒæ¡ä¸‰å±‚ç¼“å­˜æœºåˆ¶å’Œæµå¼æ¸²æŸ“
3. **å®‰å…¨æ€§**ï¼šå®æ–½å…¨é¢çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥
4. **å¯æ‰©å±•æ€§**ï¼šè®¾è®¡å¾®æœåŠ¡æ¶æ„å’Œäº‹ä»¶é©±åŠ¨ç³»ç»Ÿ
5. **å¼€å‘ä½“éªŒ**ï¼šåˆ©ç”¨ TypeScript å’Œç°ä»£å¼€å‘å·¥å…·

æŒæ¡è¿™äº›æ¦‚å¿µå°†å¸®åŠ©ä½ æ„å»ºé«˜æ€§èƒ½ã€å¯ç»´æŠ¤ã€å®‰å…¨çš„ç°ä»£ Web åº”ç”¨ã€‚
