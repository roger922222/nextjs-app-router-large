# Next.js App Router æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ - ä¼˜åŒ–æ¸…å•ä¸å®æ–½æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æä¾›å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–å®æ–½æ¸…å•ï¼ŒåŒ…å«ä¼˜å…ˆçº§æ’åºã€å…·ä½“å®æ–½æ­¥éª¤ã€éªŒæ”¶æ ‡å‡†å’ŒæŒç»­ä¼˜åŒ–ç­–ç•¥ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„ä¼˜åŒ–æ–¹æ³•ï¼Œç¡®ä¿æ€§èƒ½æ”¹è¿›æªæ–½èƒ½å¤Ÿæœ‰æ•ˆè½åœ°å¹¶æŒç»­å‘æŒ¥ä½œç”¨ã€‚

## æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§çŸ©é˜µ

### ğŸ”´ å…³é”®ä¼˜åŒ–ï¼ˆç«‹å³å®æ–½ï¼‰
- **å½±å“**: ç”¨æˆ·ä½“éªŒä¸¥é‡å—æŸ
- **å®æ–½æ—¶é—´**: 1-3å¤©
- **é¢„æœŸæ”¶ç›Š**: æ€§èƒ½æå‡50%+

### ğŸŸ¡ é‡è¦ä¼˜åŒ–ï¼ˆ2å‘¨å†…å®Œæˆï¼‰
- **å½±å“**: ç”¨æˆ·ä½“éªŒæœ‰æ˜æ˜¾å½±å“
- **å®æ–½æ—¶é—´**: 1-2å‘¨
- **é¢„æœŸæ”¶ç›Š**: æ€§èƒ½æå‡20-50%

### ğŸŸ¢ æ”¹è¿›ä¼˜åŒ–ï¼ˆ1ä¸ªæœˆå†…å®Œæˆï¼‰
- **å½±å“**: ç”¨æˆ·ä½“éªŒè½»å¾®å½±å“
- **å®æ–½æ—¶é—´**: 2-4å‘¨
- **é¢„æœŸæ”¶ç›Š**: æ€§èƒ½æå‡10-20%

## ğŸ”´ å…³é”®ä¼˜åŒ–æ¸…å•

### 1. å›¾ç‰‡ä¼˜åŒ–
```typescript
// å®æ–½æ¸…å•
- [ ] å‹ç¼©æ‰€æœ‰å›¾ç‰‡èµ„æºï¼ˆå‹ç¼©ç‡>60%ï¼‰
- [ ] ä½¿ç”¨WebPæ ¼å¼ï¼ˆèŠ‚çœ25-35%ä½“ç§¯ï¼‰
- [ ] å®ç°å“åº”å¼å›¾ç‰‡ï¼ˆsrcsetï¼‰
- [ ] å¯ç”¨æ‡’åŠ è½½ï¼ˆloading="lazy"ï¼‰
- [ ] ä½¿ç”¨CDNåŠ é€Ÿå›¾ç‰‡ä¼ è¾“

// éªŒæ”¶æ ‡å‡†
- å›¾ç‰‡åŠ è½½æ—¶é—´ < 500ms
- æ€»å›¾ç‰‡ä½“ç§¯å‡å°‘ > 40%
- Lighthouseå›¾ç‰‡è¯„åˆ† > 90
```

#### å…·ä½“å®æ–½æ–¹æ¡ˆ
```typescript
// components/OptimizedImage.tsx
import Image from 'next/image';

interface OptimizedImageProps {
  src: string;
  alt: string;
  width: number;
  height: number;
  priority?: boolean;
  quality?: number;
}

export function OptimizedImage({
  src,
  alt,
  width,
  height,
  priority = false,
  quality = 75
}: OptimizedImageProps) {
  return (
    <div className="optimized-image-container">
      <Image
        src={src}
        alt={alt}
        width={width}
        height={height}
        quality={quality}
        priority={priority}
        loading={priority ? 'eager' : 'lazy'}
        placeholder="blur"
        blurDataURL="data:image/webp;base64,..."
        style={{
          maxWidth: '100%',
          height: 'auto'
        }}
      />
    </div>
  );
}

// å›¾ç‰‡å‹ç¼©å·¥å…·å‡½æ•°
export async function compressImage(
  file: File,
  options: {
    quality: number;
    maxWidth: number;
    maxHeight: number;
  }
): Promise<Blob> {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d')!;
        
        // è®¡ç®—å‹ç¼©å°ºå¯¸
        let { width, height } = img;
        if (width > options.maxWidth) {
          height = (height * options.maxWidth) / width;
          width = options.maxWidth;
        }
        if (height > options.maxHeight) {
          width = (width * options.maxHeight) / height;
          height = options.maxHeight;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob(
          (blob) => resolve(blob!),
          'image/webp',
          options.quality / 100
        );
      };
      img.src = e.target!.result as string;
    };
    reader.readAsDataURL(file);
  });
}
```

### 2. å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–
```typescript
// å®æ–½æ¸…å•
- [ ] å†…è”å…³é”®CSSï¼ˆé¦–å±æ ·å¼ï¼‰
- [ ] å»¶è¿ŸåŠ è½½éå…³é”®CSS
- [ ] ä¼˜åŒ–JavaScriptåŠ è½½é¡ºåº
- [ ] å‡å°‘æ¸²æŸ“é˜»å¡èµ„æº
- [ ] ä½¿ç”¨font-display: swap

// éªŒæ”¶æ ‡å‡†
- First Contentful Paint < 1.8s
- Largest Contentful Paint < 2.5s
- Speed Index < 3.4s
```

#### å…³é”®CSSæå–
```typescript
// lib/critical-css.ts
export function extractCriticalCSS(html: string, css: string): string {
  // ä½¿ç”¨å·¥å…·å¦‚criticalæˆ–penthouseæå–å…³é”®CSS
  const critical = require('critical');
  
  return critical.generate({
    html,
    css,
    width: 1300,
    height: 900
  });
}

// ç»„ä»¶çº§å…³é”®æ ·å¼
export function withCriticalStyles(Component: React.ComponentType) {
  return function WrappedComponent(props: any) {
    return (
      <>
        <style jsx>{`
          /* å…³é”®æ ·å¼ */
          .critical-header {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .critical-nav {
            display: flex;
            gap: 1rem;
          }
        `}</style>
        <Component {...props} />
      </>
    );
  };
}
```

### 3. ç¼“å­˜ç­–ç•¥å®æ–½
```typescript
// å®æ–½æ¸…å•
- [ ] é…ç½®ä¸‰å±‚ç¼“å­˜æ¶æ„
- [ ] è®¾ç½®åˆç†çš„ç¼“å­˜æ—¶é—´
- [ ] å®ç°æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ
- [ ] ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- [ ] ä¼˜åŒ–ç¼“å­˜é”®ç­–ç•¥

// éªŒæ”¶æ ‡å‡†
- ç¼“å­˜å‘½ä¸­ç‡ > 80%
- å¹³å‡å“åº”æ—¶é—´å‡å°‘ > 40%
- æœåŠ¡å™¨è´Ÿè½½é™ä½ > 30%
```

## ğŸŸ¡ é‡è¦ä¼˜åŒ–æ¸…å•

### 1. ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½
```typescript
// å®æ–½æ¸…å•
- [ ] è·¯ç”±çº§ä»£ç åˆ†å‰²
- [ ] ç»„ä»¶çº§æ‡’åŠ è½½
- [ ] ç¬¬ä¸‰æ–¹åº“æŒ‰éœ€åŠ è½½
- [ ] åŠ¨æ€å¯¼å…¥ä¼˜åŒ–
- [ ] é¢„åŠ è½½å…³é”®èµ„æº

// éªŒæ”¶æ ‡å‡†
- åˆå§‹åŒ…å¤§å°å‡å°‘ > 30%
- åŠ è½½æ—¶é—´æ”¹å–„ > 25%
- Lighthouseæ€§èƒ½è¯„åˆ† > 85
```

#### åŠ¨æ€å¯¼å…¥ä¼˜åŒ–
```typescript
// lib/dynamic-imports.ts
export const DynamicComponents = {
  HeavyChart: dynamic(() => import('@/components/HeavyChart'), {
    loading: () => <Skeleton type="chart" />,
    ssr: false
  }),
  
  RichEditor: dynamic(() => import('@/components/RichEditor'), {
    loading: () => <Skeleton type="editor" />,
    ssr: false
  }),
  
  DataTable: dynamic(() => import('@/components/DataTable'), {
    loading: () => <Skeleton type="table" />,
    ssr: true
  })
};

// æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥
export function useSmartPreload() {
  useEffect(() => {
    // åŸºäºç”¨æˆ·è¡Œä¸ºçš„é¢„åŠ è½½
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const componentId = entry.target.getAttribute('data-preload');
            if (componentId) {
              preloadComponent(componentId);
            }
          }
        });
      },
      { threshold: 0.1 }
    );
    
    // è§‚å¯Ÿå¯èƒ½éœ€è¦é¢„åŠ è½½çš„å…ƒç´ 
    const preloadElements = document.querySelectorAll('[data-preload]');
    preloadElements.forEach(el => observer.observe(el));
    
    return () => observer.disconnect();
  }, []);
}
```

### 2. æ•°æ®ä¼ è¾“ä¼˜åŒ–
```typescript
// å®æ–½æ¸…å•
- [ ] å¯ç”¨Gzipå‹ç¼©
- [ ] å®ç°æ•°æ®åˆ†é¡µ
- [ ] ä¼˜åŒ–APIå“åº”æ ¼å¼
- [ ] å‡å°‘ä¼ è¾“æ•°æ®é‡
- [ ] ä½¿ç”¨CDNåŠ é€Ÿ

// éªŒæ”¶æ ‡å‡†
- æ•°æ®ä¼ è¾“é‡å‡å°‘ > 40%
- APIå“åº”æ—¶é—´ < 500ms
- ç½‘ç»œè¯·æ±‚æ•°é‡å‡å°‘ > 30%
```

## ğŸŸ¢ æ”¹è¿›ä¼˜åŒ–æ¸…å•

### 1. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
```typescript
// å®æ–½æ¸…å•
- [ ] éª¨æ¶å±åŠ è½½
- [ ] æ¸è¿›å¼æ•°æ®å±•ç¤º
- [ ] é”™è¯¯è¾¹ç•Œå¤„ç†
- [ ] åŠ è½½çŠ¶æ€ä¼˜åŒ–
- [ ] äº¤äº’åŠ¨ç”»ä¼˜åŒ–

// éªŒæ”¶æ ‡å‡†
- ç”¨æˆ·æ»¡æ„åº¦æå‡ > 20%
- è·³å‡ºç‡é™ä½ > 15%
- é¡µé¢åœç•™æ—¶é—´å¢åŠ  > 10%
```

### 2. æ€§èƒ½ç›‘æ§å®Œå–„
```typescript
// å®æ–½æ¸…å•
- [ ] Web Vitalsç›‘æ§
- [ ] é”™è¯¯ç‡ç›‘æ§
- [ ] ç”¨æˆ·è¡Œä¸ºåˆ†æ
- [ ] æ€§èƒ½è¶‹åŠ¿æŠ¥å‘Š
- [ ] è‡ªåŠ¨å‘Šè­¦æœºåˆ¶

// éªŒæ”¶æ ‡å‡†
- ç›‘æ§è¦†ç›–ç‡ > 95%
- å‘Šè­¦å‡†ç¡®ç‡ > 90%
- æŠ¥å‘Šç”Ÿæˆè‡ªåŠ¨åŒ–
```

## å®æ–½æ—¶é—´è¡¨

### ç¬¬1å‘¨ï¼šå…³é”®ä¼˜åŒ–
- Day 1-2: å›¾ç‰‡ä¼˜åŒ–å®æ–½
- Day 3-4: å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–
- Day 5-7: ç¼“å­˜ç­–ç•¥é…ç½®

### ç¬¬2-3å‘¨ï¼šé‡è¦ä¼˜åŒ–
- Week 2: ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½
- Week 3: æ•°æ®ä¼ è¾“ä¼˜åŒ–

### ç¬¬4å‘¨ï¼šæ”¹è¿›ä¼˜åŒ–
- Week 4: ç”¨æˆ·ä½“éªŒå’Œç›‘æ§å®Œå–„

## éªŒæ”¶æµ‹è¯•æ–¹æ¡ˆ

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•
```typescript
// tests/performance.test.ts
describe('Performance Tests', () => {
  test('Web Vitals metrics', async () => {
    const metrics = await page.evaluate(() => {
      return window.performance.getEntriesByType('navigation')[0];
    });
    
    expect(metrics.domContentLoadedEventEnd).toBeLessThan(2000);
    expect(metrics.loadEventEnd).toBeLessThan(3000);
  });
  
  test('API response times', async () => {
    const startTime = Date.now();
    const response = await fetch('/api/posts');
    const endTime = Date.now();
    
    expect(endTime - startTime).toBeLessThan(500);
    expect(response.status).toBe(200);
  });
  
  test('Cache functionality', async () => {
    // ç¬¬ä¸€æ¬¡è¯·æ±‚
    const start1 = Date.now();
    await fetch('/api/posts');
    const time1 = Date.now() - start1;
    
    // ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆåº”è¯¥å‘½ä¸­ç¼“å­˜ï¼‰
    const start2 = Date.now();
    await fetch('/api/posts');
    const time2 = Date.now() - start2;
    
    expect(time2).toBeLessThan(time1 * 0.5);
  });
});
```

### 2. æ€§èƒ½åŸºå‡†æµ‹è¯•
```typescript
// benchmarks/performance.benchmark.ts
import { performance } from 'perf_hooks';

export class PerformanceBenchmark {
  async runBenchmarks(): Promise<BenchmarkResults> {
    const results: BenchmarkResults = {
      webVitals: await this.benchmarkWebVitals(),
      apiPerformance: await this.benchmarkAPI(),
      cachePerformance: await this.benchmarkCache(),
      overallScore: 0
    };
    
    results.overallScore = this.calculateOverallScore(results);
    return results;
  }
  
  private async benchmarkWebVitals(): Promise<WebVitalsBenchmark> {
    // è¿è¡Œå¤šæ¬¡æµ‹è¯•å–å¹³å‡å€¼
    const iterations = 10;
    const results: number[] = [];
    
    for (let i = 0; i < iterations; i++) {
      const result = await this.measureWebVitals();
      results.push(result);
    }
    
    return {
      avg: results.reduce((a, b) => a + b) / results.length,
      min: Math.min(...results),
      max: Math.max(...results),
      p95: this.percentile(results, 0.95)
    };
  }
  
  private calculateOverallScore(results: BenchmarkResults): number {
    // ç»¼åˆè¯„åˆ†ç®—æ³•
    const weights = {
      webVitals: 0.4,
      apiPerformance: 0.3,
      cachePerformance: 0.3
    };
    
    return Math.round(
      weights.webVitals * results.webVitals.avg +
      weights.apiPerformance * results.apiPerformance.avg +
      weights.cachePerformance * results.cachePerformance.avg
    );
  }
}
```

### 3. ç”¨æˆ·ä½“éªŒæµ‹è¯•
```typescript
// tests/user-experience.test.ts
describe('User Experience Tests', () => {
  test('Loading states', async () => {
    await page.goto('/posts');
    
    // æ£€æŸ¥éª¨æ¶å±æ˜¾ç¤º
    const skeleton = await page.$('.skeleton');
    expect(skeleton).toBeTruthy();
    
    // ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ
    await page.waitForSelector('.post-item', { timeout: 2000 });
    
    // éªŒè¯æ•°æ®æ­£ç¡®æ˜¾ç¤º
    const posts = await page.$$('.post-item');
    expect(posts.length).toBeGreaterThan(0);
  });
  
  test('Error handling', async () => {
    // æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
    await page.setOfflineMode(true);
    await page.goto('/posts');
    
    // æ£€æŸ¥é”™è¯¯çŠ¶æ€æ˜¾ç¤º
    const errorElement = await page.$('.error-message');
    expect(errorElement).toBeTruthy();
    
    // æ£€æŸ¥é‡è¯•åŠŸèƒ½
    const retryButton = await page.$('button:has-text("é‡è¯•")');
    expect(retryButton).toBeTruthy();
  });
});
```

## æŒç»­ä¼˜åŒ–ç­–ç•¥

### 1. å®šæœŸæ€§èƒ½å®¡è®¡
- **æœˆåº¦å®¡è®¡**: å…¨é¢æ€§èƒ½æ£€æŸ¥
- **å­£åº¦è¯„ä¼°**: æ·±åº¦ä¼˜åŒ–åˆ†æ
- **å¹´åº¦è§„åˆ’**: æ¶æ„å‡çº§è®¡åˆ’

### 2. æ€§èƒ½é¢„ç®—ç®¡ç†
```typescript
// budgets/performance-budget.json
{
  "budgets": [
    {
      "resourceType": "script",
      "budget": 300,
      "warning": 250
    },
    {
      "resourceType": "image",
      "budget": 500,
      "warning": 400
    },
    {
      "resourceType": "total",
      "budget": 1000,
      "warning": 800
    }
  ],
  "metrics": [
    {
      "metric": "firstContentfulPaint",
      "budget": 2000,
      "warning": 1500
    },
    {
      "metric": "largestContentfulPaint",
      "budget": 3000,
      "warning": 2500
    }
  ]
}
```

### 3. è‡ªåŠ¨åŒ–ç›‘æ§å‘Šè­¦
```typescript
// monitoring/performance-alerts.ts
export class PerformanceAlertManager {
  private thresholds = {
    webVitals: {
      LCP: 4000,
      FID: 300,
      CLS: 0.25
    },
    api: {
      responseTime: 1000,
      errorRate: 0.05
    },
    cache: {
      hitRate: 0.7
    }
  };
  
  async checkMetrics(metrics: PerformanceMetrics): Promise<Alert[]> {
    const alerts: Alert[] = [];
    
    // Web Vitals å‘Šè­¦
    if (metrics.webVitals.LCP > this.thresholds.webVitals.LCP) {
      alerts.push({
        type: 'warning',
        metric: 'LCP',
        value: metrics.webVitals.LCP,
        threshold: this.thresholds.webVitals.LCP,
        message: 'Largest Contentful Paint è¶…è¿‡é˜ˆå€¼'
      });
    }
    
    // API æ€§èƒ½å‘Šè­¦
    if (metrics.api.avgResponseTime > this.thresholds.api.responseTime) {
      alerts.push({
        type: 'error',
        metric: 'API_ResponseTime',
        value: metrics.api.avgResponseTime,
        threshold: this.thresholds.api.responseTime,
        message: 'API å¹³å‡å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼'
      });
    }
    
    return alerts;
  }
}
```

## æ€»ç»“

é€šè¿‡è¿™å¥—å®Œæ•´çš„æ€§èƒ½ä¼˜åŒ–å®æ–½æŒ‡å—ï¼Œå¯ä»¥ç³»ç»Ÿæ€§åœ°æå‡ Next.js åº”ç”¨çš„æ€§èƒ½è¡¨ç°ã€‚å…³é”®åœ¨äºï¼š

1. **åˆ†é˜¶æ®µå®æ–½**: æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥æ¨è¿›
2. **æ•°æ®é©±åŠ¨**: åŸºäºç›‘æ§æ•°æ®è¿›è¡Œä¼˜åŒ–
3. **æŒç»­æ”¹è¿›**: å»ºç«‹é•¿æœŸä¼˜åŒ–æœºåˆ¶
4. **å›¢é˜Ÿåä½œ**: ç¡®ä¿å„è§’è‰²ååŒé…åˆ

éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥æ˜¾è‘—æå‡åº”ç”¨çš„æ€§èƒ½æŒ‡æ ‡ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œé™ä½è¿è¥æˆæœ¬ã€‚